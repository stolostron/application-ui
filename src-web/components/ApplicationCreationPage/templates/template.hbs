
{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Application ============================ }}
{{! ========================================================== }}
{{! ========================================================== }}
apiVersion: v1                      
kind: Namespace
metadata:
  name: {{{namespace}}}                             
---
apiVersion: app.k8s.io/v1beta1
kind: Application
metadata:
  name: {{{name}}}
  namespace: {{{namespace}}}
spec:
  componentKinds:
  - group: apps.open-cluster-management.io
    kind: Subscription
  descriptor: {}
  selector:
    matchExpressions:
      - key: app
        operator: In
        values: 
          - {{{name}}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Channel(s) ============================= }}
{{! ========================================================== }}
{{! ========================================================== }}


{{#each channels}}

{{#switch channelType}}

{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Github channel ========================= }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'github'}}

{{#unless ../channelNamespace}}
---
apiVersion: v1                      
kind: Namespace
metadata:
  name: {{{../../../name}}}-{{{../../channelName}}}-ns
---
apiVersion: apps.open-cluster-management.io/v1
kind: Channel
metadata:
  name: {{{../../../name}}}-{{{../../channelName}}}
  namespace: {{{../../../name}}}-{{{../../channelName}}}-ns
spec:
  type: Git
  pathname: '{{{../../githubURL}}}'
{{#if ../../githubUser}}
  secretRef:
    name: {{{../../../name}}}-git-authentication-{{@index}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{{../../../name}}}-git-authentication-{{@index}}
  namespace: {{{../../../name}}}-{{{../../channelName}}}-ns
data:
  user: {{{../../githubUser}}}
  accessToken: {{{../../githubAccessId}}}
{{/if}}
{{/unless}}      
---
apiVersion: apps.open-cluster-management.io/v1
kind: Subscription
metadata:
  annotations:
    apps.open-cluster-management.io/git-branch: {{{../githubBranch}}}
    apps.open-cluster-management.io/git-path: {{{../githubPath}}}
  labels:
    app: {{{../../name}}}
  name: {{{../../name}}}-subscription-{{@index}}
  namespace: {{{../../namespace}}}
spec:
{{#if ../channelNamespace}}
  channel: {{{../../channelNamespace}}}/{{{../../channelName}}}
{{else}}
  channel: {{{../../../name}}}-{{{../../channelName}}}-ns/{{{../../../name}}}-{{{../../channelName}}}
{{/if}}
  placement:
    placementRef:
      kind: PlacementRule
      name: {{{../../name}}}-placement
{{#if ../../timeWindow.mode}}
  timewindow:
    windowtype: {{{../../../timeWindow.mode}}}
    location: {{{../../../timeWindow.timezone}}}
    weekdays: [{{{../../../timeWindow.days}}}]
    {{#if ../../../timeWindow.showTimeSection}}
    hours:
      {{#each ../../../timeWindow.timeList}}
      {{#if validTime}}
      - start: "{{{start}}}"
        end: "{{{end}}}"
      {{/if}}
      {{/each}}
    {{/if}}
{{/if}}

{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Helmrepo channel ==================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'helmrepo'}}
  
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Objectstore channel ==================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'objectstore'}}
---
apiVersion: v1                      
kind: Namespace
metadata:
  name: {{{../../name}}}-{{{../channelName}}}-ns
---
apiVersion: apps.open-cluster-management.io/v1
kind: Channel
metadata:
  name: {{{../../name}}}-{{{../channelName}}}
  namespace: {{{../../name}}}-{{{../channelName}}}-ns
spec:
  type: ObjectBucket
  pathname: '{{{../objectstoreURL}}}'
{{#if ../accessKey}}
  secretRef:
    name: {{{../../../name}}}-objectstore-authentication-{{@index}}
---
apiVersion: v1
kind: Secret
metadata:
  name: {{{../../../name}}}-objectstore-authentication-{{@index}}
  namespace: {{{../../../name}}}-{{{../../channelName}}}-ns
data:
  AccessKeyID: {{{../../accessKey}}}
  SecretAccessKey: {{{../../secretKey}}}
{{/if}}      
---
apiVersion: apps.open-cluster-management.io/v1
kind: Subscription
metadata:
  labels:
    app: {{{../../name}}}
  name: {{{../../name}}}-subscription-{{@index}}
  namespace: {{{../../namespace}}}
spec:
  channel: {{{../../name}}}-{{{../channelName}}}-ns/{{{../../name}}}-{{{../channelName}}}
  placement:
    placementRef:
      kind: PlacementRule
      name: {{{../../name}}}-placement
{{#if ../../timeWindow.mode}}
  timewindow:
    windowtype: {{{../../../timeWindow.mode}}}
    location: {{{../../../timeWindow.timezone}}}
    weekdays: [{{{../../../timeWindow.days}}}]
    {{#if ../../../timeWindow.showTimeSection}}
    hours:
      {{#each ../../../timeWindow.timeList}}
      {{#if validTime}}
      - start: "{{{start}}}"
        end: "{{{end}}}"
      {{/if}}
      {{/each}}
    {{/if}}
{{/if}}
     
{{/case}}


{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Deployable channel ===================== }}
{{! ========================================================== }}
{{! ========================================================== }}
{{#case 'deployable'}}
  
{{/case}}

{{/switch}}
{{/each}}
  

{{! ========================================================== }}
{{! ========================================================== }}
{{! ==================Placement Rule ========================= }}
{{! ========================================================== }}
{{! ========================================================== }}

---
apiVersion: apps.open-cluster-management.io/v1
kind: PlacementRule
metadata:
  labels:
    app: {{{name}}}
  name: {{{name}}}-placement
  namespace: {{{namespace}}}
{{#if clusterSelector.mode}}  
spec:
  {{#if clusterReplicas}}
  clusterReplicas: {{{clusterReplicas}}}
  {{/if}}  
  clusterSelector:
    matchLabels:
      {{#each clusterSelector.clusterLabelsList}}
      {{#if validValue}}
      {{{labelName}}}: {{{labelValue}}}
      {{/if}}
      {{/each}} 
  {{#if online-cluster-only-checkbox}}
  clusterConditions:
    - type: ManagedClusterConditionAvailable
      status: "True"
  {{/if}}
{{else}}
  {{#if online-cluster-only-checkbox}}
spec:
  {{#if clusterReplicas}}
  clusterReplicas: {{{clusterReplicas}}}
  {{/if}} 
  clusterConditions:
    - type: ManagedClusterConditionAvailable
      status: "True"
  {{else}} 
  {{#if clusterReplicas}}
spec:  
  clusterReplicas: {{{clusterReplicas}}}
  {{/if}}    
  {{/if}}
{{/if}}
